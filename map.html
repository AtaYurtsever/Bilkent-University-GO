<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BuGo Map</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.4/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.4/build/ol.js"></script>
    
  </head>
  <body>
    <button id="Bilkent">To Bilkent</button>
    <select id="Buildings" onchange="onChange()"></select>
    <div id="status"></div>
    <div id="map" class="map">
    <script>
    var geoURL = 'https://raw.githubusercontent.com/Dogacel/teamazm-cs102/Map_Geojson/map.geojson?token=AdZqbG23YwWTyi97BhTeoiZzmPad0SlIks5arrWIwA%3D%3D'

    //request and take geoUrl json
    var request = new XMLHttpRequest();
    request.open('GET',geoURL);
    request.responseType = 'json';
    request.send();
    
    request.onload = function() {
      var geo = request.response;
      addSelectIndexes(geo);
    } 


    //adds select indexes 
    function addSelectIndexes ( arr){
      html = '';
      for( var i = 0 ; i < arr.features.length ; i++){
        html += "<option value=" + middlePointArray(arr.features[i].geometry.coordinates[0]) 
                             + ">" + arr.features[i].properties["name"] + "</option>";
      }
      html += "<option value=" + [32.748428,39.86800] 
                             + "> fen fak havuz </option>";
      document.getElementById("Buildings").innerHTML = html;
    }


    function middlePointArray( arrr){
      var xMean = 0, yMean = 0;
      for( var i = 0; i < arrr.length; i++){
        xMean = xMean + arrr[i][0];
        yMean = yMean + arrr[i][1];
      }
      xMean /= arrr.length;
      yMean /= arrr.length;
      
      return [xMean,yMean];
    }

     var fenFakHavuz = ol.proj.fromLonLat([32.748428,39.86800]);

     var view = new ol.View({//start view
       center : fenFakHavuz,
       zoom : 16
     })

     var raster = new ol.layer.Tile({//main map
        source: new ol.source.OSM()
      });




      var vector = new ol.layer.Vector({//geojson vectors
        source: new ol.source.Vector({
          url: geoURL,
          format: new ol.format.GeoJSON()
          
        })
      });

      //create map from raster and vector layers
      var map = new ol.Map({
        //interactions : ol.interaction.defaults().extend([select]),
        layers: [raster, vector],
        target: 'map',
        view: view
      });
    


      //------------------------------------------------Keep working with this part
      map.on('pointermove', function(evt) {
        if (evt.dragging) {
          return;
        }
        var pixel = map.getEventPixel(evt.originalEvent);
        //displayFeatureInfo(pixel);
      });

      map.on('click', function(evt) {
        displayFeatureInfo(evt.pixel);
      });

      var displayFeatureInfo = function(pixel) {
       var feature = map.forEachFeatureAtPixel(pixel, function(feature) {
          return feature;
        });

        
        if (feature) {
          alert('name : ' + feature.get('name'));
        } else {
          
        }
}
//--------------------------------------------------



      
      
      //I took this function from an ol example and they took it from an opensource github repo so yey copy paste programming
       // A bounce easing method (from https://github.com/DmitryBaranovskiy/raphael).
       
       function bounce(t) {
        var s = 7.5625, p = 2.75, l;
        if (t < (1 / p)) {
          l = s * t * t;
        } else {
          if (t < (2 / p)) {
            t -= (1.5 / p);
            l = s * t * t + 0.75;
          } else {
            if (t < (2.5 / p)) {
              t -= (2.25 / p);
              l = s * t * t + 0.9375;
            } else {
              t -= (2.625 / p);
              l = s * t * t + 0.984375;
            }
          }
        }
        return l;
      }

      //flyTo function
      function flyTo(location, done) {
        var duration = 2000;
        var zoom = 16;
        var parts = 2;
        var called = false;
        function callback(complete) {
          --parts;
          if (called) {
            return;
          }
          if (parts === 0 || !complete) {
            called = true;
            done(complete);
          }
        }
        view.animate({
          center: location,
          duration: duration
        }, callback);
        view.animate({
          zoom: zoom - 1,
          duration: duration / 2
        }, {
          zoom: zoom,
          duration: duration / 2
        }, callback);
      }
        //-----
      //Buildings dropdown interaction
      function onChange(){
         var x = document.getElementById('Buildings').value;
         var y = x.split(',');
         console.log(y)
         console.log(x);
         var buildingView = ol.proj.fromLonLat(y);
         console.log(buildingView);
           
         flyTo( buildingView, function(){});
         
      };

      // to Bilkent button interaction
      document.getElementById('Bilkent').addEventListener('click', function() {
        console.log(fenFakHavuz);
        flyTo(fenFakHavuz ,function() {});
      });
        

      var select = new ol.interaction.Select();//define how to select
      //selecting buildings
      if (select !== null) {
        console.log(select);
          map.addInteraction(select);
          select.on('select', function(e) {
            
                
                
            //alert(e.target.getFeatures.);
            
          });
          
        }
    </script>
    </div>
  </body>
</html>